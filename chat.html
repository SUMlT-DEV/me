<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PeerJS for WebRTC -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

    <style>
        /* Modern font settings */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Custom scrollbar for chat */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-[100dvh] overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const IconUser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const IconMessage = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const IconLink = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>;
        const IconCopy = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>;
        const IconSend = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const IconLoader = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const IconLogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconShield = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;

        // --- UI COMPONENTS ---
        
        // MOVED OUTSIDE App to prevent re-renders causing focus loss
        const Layout = ({ children }) => (
            <div className="min-h-[100dvh] flex items-center justify-center p-4 bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
                <div className="w-full max-w-md bg-white/80 backdrop-blur-2xl rounded-[32px] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.1)] border border-white/50 overflow-hidden relative transition-all duration-500">
                    {children}
                </div>
            </div>
        );

        const App = () => {
            // State
            const [step, setStep] = useState('landing'); // landing, waiting, joining, chat
            const [role, setRole] = useState('host'); // host, guest
            const [myPeerId, setMyPeerId] = useState('');
            const [username, setUsername] = useState('');
            const [targetName, setTargetName] = useState('');
            const [targetPeerId, setTargetPeerId] = useState('');
            const [message, setMessage] = useState('');
            const [chatHistory, setChatHistory] = useState([]);
            const [status, setStatus] = useState('');
            const [error, setError] = useState('');
            const [isConnected, setIsConnected] = useState(false);

            // Refs
            const peerRef = useRef(null);
            const connRef = useRef(null);
            const chatBoxRef = useRef(null);

            // Init
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const room = params.get('room');
                const name = params.get('name');
                
                if (room && name) {
                    setRole('guest');
                    setTargetPeerId(room);
                    setTargetName(decodeURIComponent(name));
                    setStep('joining');
                }

                return () => {
                    if (peerRef.current) peerRef.current.destroy();
                };
            }, []);

            // Auto-scroll
            useEffect(() => {
                if (chatBoxRef.current) {
                    chatBoxRef.current.scrollTop = chatBoxRef.current.scrollHeight;
                }
            }, [chatHistory]);

            // --- HOST ---
            const initializeHost = () => {
                if (!username.trim()) return setError("Please enter a username.");
                setError('');
                setStatus('Securing connection...');
                
                const peer = new window.Peer();
                peerRef.current = peer;

                peer.on('open', (id) => {
                    setMyPeerId(id);
                    setStep('waiting');
                    setStatus('Ready to connect.');
                });

                peer.on('connection', (conn) => {
                    connRef.current = conn;
                    setupConnectionEvents(conn);
                });

                peer.on('error', (err) => {
                    console.error(err);
                    setError("Connection error. Refresh and try again.");
                });
            };

            // --- GUEST ---
            const joinChat = () => {
                if (!username.trim()) return setError("Please enter a username.");
                setError('');
                setStatus(`Connecting securely to ${targetName}...`);

                const peer = new window.Peer();
                peerRef.current = peer;

                peer.on('open', (id) => {
                    setMyPeerId(id);
                    const conn = peer.connect(targetPeerId, {
                        metadata: { username: username }
                    });
                    connRef.current = conn;
                    setupConnectionEvents(conn);
                });

                peer.on('error', (err) => {
                    console.error(err);
                    setError("Could not connect. User might be offline.");
                    setStep('joining');
                });
            };

            // --- SHARED ---
            const setupConnectionEvents = (conn) => {
                conn.on('open', () => {
                    setIsConnected(true);
                    setStep('chat');
                    if (role === 'host' && conn.metadata) {
                        setTargetName(conn.metadata.username);
                        conn.send({ type: 'handshake', name: username });
                    }
                });

                conn.on('data', (data) => {
                    if (data.type === 'message') {
                        setChatHistory(prev => [...prev, { sender: 'them', text: data.text, time: new Date() }]);
                    }
                });

                conn.on('close', () => {
                    setIsConnected(false);
                    alert('Session ended.');
                    window.location.href = window.location.pathname; // Soft reload
                });
            };

            const sendMessage = (e) => {
                e.preventDefault();
                if (!message.trim() || !isConnected) return;

                const msgData = { type: 'message', text: message };
                connRef.current.send(msgData);

                setChatHistory(prev => [...prev, { sender: 'me', text: message, time: new Date() }]);
                setMessage('');
            };

            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${myPeerId}&name=${encodeURIComponent(username)}`;
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(url).then(() => setStatus('Link copied!'));
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = url;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setStatus('Link copied!');
                    } catch (err) {
                        setStatus('Failed to copy.');
                    }
                    document.body.removeChild(textArea);
                }
                setTimeout(() => setStatus('Waiting for connection...'), 3000);
            };

            const formatTime = (date) => date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // --- VIEWS ---
            if (step === 'landing') {
                return (
                    <Layout>
                        <div className="p-10 text-center">
                            <div className="mx-auto bg-gradient-to-tr from-indigo-600 to-purple-600 w-24 h-24 rounded-[2rem] flex items-center justify-center mb-8 shadow-xl shadow-indigo-200 animate-float">
                                <div className="text-white"><IconShield /></div>
                            </div>
                            <h1 className="text-3xl font-bold text-slate-800 mb-3 tracking-tight">Private Chat</h1>
                            <p className="text-slate-500 mb-10 leading-relaxed max-w-[260px] mx-auto">
                                Secure, Serverless, Ephemeral.<br/>
                                <span className="text-xs font-medium text-slate-400">No databases. No history. Just now.</span>
                            </p>
                            
                            <div className="space-y-4">
                                <div className="relative group">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-600 transition-colors"><IconUser /></div>
                                    <input
                                        autoFocus
                                        type="text"
                                        placeholder="Choose your alias"
                                        className="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400 font-medium text-slate-700"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && initializeHost()}
                                    />
                                </div>
                                {error && <div className="text-rose-500 text-sm flex items-center justify-center gap-2 bg-rose-50 py-2 rounded-xl"><IconAlert /> {error}</div>}
                                <button onClick={initializeHost} className="w-full bg-slate-900 hover:bg-black active:scale-[0.98] text-white font-semibold py-4 rounded-2xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                                    Create Secure Room
                                </button>
                            </div>
                        </div>
                    </Layout>
                );
            }

            if (step === 'waiting') {
                return (
                    <Layout>
                        <div className="p-10 text-center">
                            <div className="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 relative">
                                <div className="absolute inset-0 bg-emerald-400 rounded-full animate-ping opacity-20"></div>
                                <IconLink />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Room Ready</h2>
                            <p className="text-slate-500 mb-8">Share this private link to begin.</p>
                            
                            <div className="bg-slate-50 border border-slate-200 p-4 rounded-2xl mb-6 text-left relative group hover:border-indigo-300 transition-colors">
                                <div className="text-[10px] text-slate-400 mb-1 uppercase tracking-wider font-bold">Private Invite Link</div>
                                <div className="text-sm text-slate-600 font-mono truncate pr-10 opacity-70">
                                    {window.location.origin}{window.location.pathname}?room={myPeerId}...
                                </div>
                            </div>

                            <button onClick={copyLink} className="w-full bg-indigo-600 hover:bg-indigo-700 active:scale-[0.98] text-white font-semibold py-4 rounded-2xl transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 mb-6">
                                {status === 'Link copied!' ? <IconCheck/> : <IconCopy />}
                                {status === 'Link copied!' ? 'Copied to Clipboard' : 'Copy Link'}
                            </button>
                            
                            <div className="flex items-center justify-center gap-2 text-xs font-medium text-slate-400 bg-slate-50 py-2.5 px-4 rounded-full inline-flex">
                                <div className="w-4 h-4 text-indigo-500"><IconLoader /></div> 
                                {status === 'Link copied!' ? 'Waiting for peer...' : 'Initializing secure handshake...'}
                            </div>
                        </div>
                    </Layout>
                );
            }

            if (step === 'joining') {
                return (
                    <Layout>
                        <div className="p-10 text-center">
                            <div className="w-16 h-16 bg-purple-100 text-purple-600 rounded-2xl mx-auto mb-6 flex items-center justify-center rotate-6 shadow-sm">
                                <div className="-rotate-6"><IconUser /></div>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 mb-2">Join Private Chat</h1>
                            <p className="text-slate-500 mb-8">Connecting securely to <span className="font-semibold text-purple-600">{targetName}</span></p>
                            
                            <div className="space-y-4">
                                <div className="relative group">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-purple-600 transition-colors"><IconUser /></div>
                                    <input
                                        autoFocus
                                        type="text"
                                        placeholder="Your Alias"
                                        className="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none transition-all placeholder:text-slate-400 font-medium text-slate-700"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && joinChat()}
                                    />
                                </div>
                                {error && <div className="text-rose-500 text-sm flex items-center justify-center gap-2 bg-rose-50 py-2 rounded-xl"><IconAlert /> {error}</div>}
                                <button onClick={joinChat} className="w-full bg-purple-600 hover:bg-purple-700 active:scale-[0.98] text-white font-semibold py-4 rounded-2xl transition-all shadow-lg shadow-purple-200 flex items-center justify-center gap-2">
                                    {status.includes('Connecting') ? <div className="w-5 h-5"><IconLoader /></div> : 'Join Securely'}
                                </button>
                            </div>
                        </div>
                    </Layout>
                );
            }

            if (step === 'chat') {
                return (
                    <div className="fixed inset-0 bg-[#f0f2f5] flex flex-col font-sans">
                        {/* Header */}
                        <header className="bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm z-20">
                            <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md ${role === 'host' ? 'bg-gradient-to-br from-indigo-500 to-purple-600' : 'bg-gradient-to-br from-purple-500 to-pink-600'}`}>
                                    {targetName.charAt(0).toUpperCase()}
                                </div>
                                <div className="leading-tight">
                                    <h3 className="font-bold text-slate-800 text-base">{targetName}</h3>
                                    <p className="text-[11px] uppercase tracking-wide text-emerald-600 font-bold flex items-center gap-1.5">
                                        <IconShield /> Secure Serverless Connection
                                    </p>
                                </div>
                            </div>
                            <button onClick={() => window.location.href = window.location.pathname} className="p-2.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-all" title="End Session">
                                <IconLogOut />
                            </button>
                        </header>

                        {/* Chat Area */}
                        <div ref={chatBoxRef} className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#f8fafc] custom-scroll">
                            {chatHistory.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-slate-400 opacity-60">
                                    <div className="bg-slate-100 p-6 rounded-full mb-4 animate-float"><IconShield /></div>
                                    <p className="text-sm font-medium">Encrypted Channel Established.</p>
                                    <p className="text-xs mt-1">Messages flow directly between devices.</p>
                                </div>
                            ) : (
                                chatHistory.map((msg, index) => {
                                    const isMe = msg.sender === 'me';
                                    return (
                                        <div key={index} className={`flex w-full msg-enter ${isMe ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`
                                                relative max-w-[85%] md:max-w-[70%] px-5 py-3 shadow-sm text-[15px] leading-relaxed
                                                ${isMe 
                                                    ? 'bg-indigo-600 text-white rounded-[22px] rounded-tr-md' 
                                                    : 'bg-white text-slate-700 rounded-[22px] rounded-tl-md border border-slate-100'}
                                            `}>
                                                <div className="mb-1 break-words">{msg.text}</div>
                                                <div className={`text-[10px] font-medium text-right mt-1 opacity-70 ${isMe ? 'text-indigo-100' : 'text-slate-400'}`}>
                                                    {formatTime(msg.time)}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>

                        {/* Input Area */}
                        <div className="bg-white p-3 md:p-4 border-t border-slate-200">
                            <form onSubmit={sendMessage} className="flex gap-2 items-end max-w-4xl mx-auto">
                                <div className="flex-1 bg-slate-100 rounded-[24px] border-2 border-transparent focus-within:border-indigo-100 focus-within:bg-white transition-all flex items-center overflow-hidden">
                                    <input
                                        autoFocus
                                        type="text"
                                        className="w-full bg-transparent border-0 px-6 py-3.5 focus:ring-0 text-slate-800 placeholder:text-slate-400 outline-none"
                                        placeholder="Type a secured message..."
                                        value={message}
                                        onChange={(e) => setMessage(e.target.value)}
                                        autoComplete="off"
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={!message.trim()} 
                                    className={`
                                        w-12 h-12 rounded-full flex items-center justify-center shadow-lg transition-all duration-300
                                        ${message.trim() 
                                            ? 'bg-indigo-600 hover:bg-indigo-700 text-white transform hover:scale-105 active:scale-95' 
                                            : 'bg-slate-100 text-slate-300 cursor-default'}
                                    `}
                                >
                                    <div className={message.trim() ? 'ml-0.5' : ''}><IconSend /></div>
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
